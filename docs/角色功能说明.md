# 煤矿技改概算管控系统 - 角色与功能模块说明

> 平煤神马塔能伊斯法拉公司煤矿（原舒拉8号井）技术改造项目
> 项目建设总投资: **56,397.84万元** | 子工程: **184项** | 费用类别: **6大类**

---

## 一、系统角色定义

| 角色 | 账号 | 密码 | 定位 |
|------|------|------|------|
| 管理员（admin） | admin | admin123 | 系统管理员，拥有全部功能权限 |
| 领导（leader） | leader | leader123 | 矿领导层，全局查看 + 模拟分析 + 审批 |
| 工程部（department） | engineer | eng123 | 工程部门员工，本部门数据录入 + 全局查看 |
| 普通员工（viewer） | viewer | view123 | 只读查看驾驶舱、项目、支出、预警、报表 |

---

## 二、功能模块与角色权限对照表

| 功能模块 | 管理员 | 领导 | 工程部 | 普通员工 | 说明 |
|----------|--------|------|--------|----------|------|
| 领导驾驶舱 | 查看 | 查看 | 查看 | 查看 | 全局概览页面，所有角色只读 |
| 工程项目管理 | 增删改查 | 增改查 | 增改查 | 只读 | 工程部可录入进度 |
| 概算科目管理 | 增删改查 | 增改查 | -- | -- | 仅管理层可管理科目 |
| 支出管理 | 增删改查 | 增改查 | 增改查 | 只读 | 工程部可录入支出 |
| 现金流管理 | 增删改查+审批 | 增改查+审批 | 新增+查看 | 查看 | 收入/支出跟踪、月度图表、导出、审批流 |
| 模拟分析中心 | 全部 | 全部 | -- | -- | 仅管理层可使用 |
| 预警管理 | 查看+检查+解决 | 查看+检查+解决 | 查看 | 查看 | 工程部/员工只能查看 |
| 月度考核报表 | 查看+导出 | 查看+导出 | 查看+导出 | 查看+导出 | 所有角色可导出 Excel |
| 用户管理 | 增删改查 | -- | -- | -- | 仅管理员可管理用户 |

> **说明**: "--" 表示该角色在菜单中看不到此模块，且后端 API 也会返回 403 权限不足。

---

## 三、各功能模块详细说明

### 模块1：领导驾驶舱

**访问路径**: `/dashboard`
**可访问角色**: 全部（admin、leader、department、viewer）

**关于所有角色均可访问的合理性说明**:
- 驾驶舱是**纯只读概览页面**，不包含任何写操作
- 所有角色查看全局项目状态有助于信息透明，促进团队协作
- 涉及操作权限的功能（模拟分析、概算科目管理）已单独控制

**展示内容**:

| 展示项 | 说明 |
|--------|------|
| 总概算执行仪表盘 | 56,397.84万元总盘子，已用/剩余/使用率 |
| 六大费用类别对比 | 矿建/土建/安装/设备/其他/预备费 概算 vs 实际 |
| 子工程进度概览 | 184个子工程的完成率、状态分布 |
| 弹性预备金状态 | 预备金总额、已动用、剩余 |
| Top5 风险工程 | 概算使用率最高的5个子工程 |
| 月度支出趋势 | 按月汇总的支出折线图 |
| 关键 KPI | 概算控制率、工期准时率、成本节约率、工效指数 |

---

### 模块2：工程项目管理

**访问路径**: `/projects`、`/projects/:id`
**可访问角色**: 全部

| 功能 | admin | leader | department | viewer |
|------|-------|--------|------------|--------|
| 查看项目列表及详情 | Yes | Yes | Yes | Yes |
| 创建/编辑主项目 | Yes | Yes | -- | -- |
| 创建/编辑子工程 | Yes | Yes | Yes | -- |
| 删除子工程 | Yes | -- | -- | -- |
| 管理里程碑节点 | Yes | Yes | Yes | -- |
| 填报进度 | Yes | Yes | Yes | -- |

**子工程数据结构**:
- 名称、所属费用类别
- 分配概算、实际支出
- 进度百分比、状态（未开始/进行中/完成/延期）
- 计划起止时间、负责部门

---

### 模块3：概算科目管理

**访问路径**: `/budget`
**可访问角色**: admin、leader

| 功能 | admin | leader |
|------|-------|--------|
| 查看三级科目树 | Yes | Yes |
| 创建/编辑科目 | Yes | Yes |
| 删除科目 | Yes | -- |
| 管理费用项 | Yes | Yes |

**三级科目体系**:
- 一级科目（6项）: 矿建工程费、土建工程费、安装工程费、设备购置费、其他费用、预备费
- 二级科目: 按工程/功能拆分（如主井筒改造、巷道掘进、通风系统等）
- 三级科目: 具体支出项（人员工资、材料费、机械费等）

---

### 模块4：支出管理

**访问路径**: `/expenditures`
**可访问角色**: 全部

| 功能 | admin | leader | department | viewer |
|------|-------|--------|------------|--------|
| 查看支出列表 | Yes | Yes | Yes | Yes |
| 手动录入支出 | Yes | Yes | Yes | -- |
| Excel 批量导入 | Yes | Yes | Yes | -- |
| 删除支出记录 | Yes | -- | -- | -- |

**支出记录字段**:
- 关联子工程、关联科目
- 日期、金额（万元）、描述
- 凭证号、来源（手动/Excel/NCC）

---

### 模块5：模拟分析中心

**访问路径**: `/simulation`
**可访问角色**: admin、leader

此模块包含三大分析功能，详细计算方法见后文"计算逻辑"章节。

| 功能 | admin | leader |
|------|-------|--------|
| What-if 参数调整分析 | Yes | Yes |
| 敏感性分析（龙卷风图） | Yes | Yes |
| 情景对比（保守/正常/乐观） | Yes | Yes |
| 删除已保存的模拟方案 | Yes | Yes |

---

### 模块6：预警管理

**访问路径**: `/alerts`
**可访问角色**: 全部

| 功能 | admin | leader | department | viewer |
|------|-------|--------|------------|--------|
| 查看预警列表 | Yes | Yes | Yes | Yes |
| 查看预警统计 | Yes | Yes | Yes | Yes |
| 运行预警检查 | Yes | Yes | -- | -- |
| 标记已读 | Yes | Yes | Yes | Yes |
| 解决预警 | Yes | Yes | -- | -- |

**三种预警类型**:
1. **概算超支预警**: 子工程实际支出占概算比例超过阈值
2. **工期延误预警**: 实际进度落后于期望进度
3. **消耗速率预警**: 按当前消耗速率预测总支出是否超概算

---

### 模块7：现金流管理

**访问路径**: `/cashflow`
**可访问角色**: 全部

| 功能 | admin | leader | department | viewer |
|------|-------|--------|------------|--------|
| 查看现金流数据 | Yes | Yes | Yes | Yes |
| 创建流水记录 | Yes | Yes | Yes | -- |
| 编辑流水记录 | Yes | Yes | -- | -- |
| 审批流水记录 | Yes | Yes | -- | -- |
| 删除流水记录 | Yes | -- | -- | -- |

**功能特性**:
- 收入/支出流水跟踪
- 月度收支趋势图表
- 导出 Excel
- 审批工作流

---

### 模块8：月度考核报表

**访问路径**: `/reports`
**可访问角色**: 全部

| 功能 | admin | leader | department | viewer |
|------|-------|--------|------------|--------|
| 查看月度报表 | Yes | Yes | Yes | Yes |
| 导出 Excel | Yes | Yes | Yes | Yes |

**报表内容**:
- 报表概览（总概算、本月支出、累计支出、使用率）
- 费用类别汇总（各类别概算/已用/使用率）
- 子工程执行情况（概算/支出/进度/工期状态/风险等级）
- 预测与建议（下月预估支出、自动生成建议）

---

### 模块9：用户管理

**访问路径**: `/users`
**可访问角色**: admin

| 功能 | admin |
|------|-------|
| 查看用户列表 | Yes |
| 创建用户 | Yes |
| 编辑用户（角色、部门） | Yes |
| 启用/禁用用户 | Yes |

---

## 四、核心计算逻辑

### 4.1 概算相关计算

#### 概算使用率

```
概算使用率(%) = 累计实际支出 / 分配概算 × 100
```

- 应用于: 驾驶舱、项目详情、报表、预警

#### 弹性预备金

```
预备金总额 = 项目总概算 × 预备金比例
  其中预备金比例默认 7%（可配置 5%-10%）

可用概算 = 项目总概算 × (1 - 预备金比例)
  即: 56,397.84 × (1 - 0.07) = 52,449.99万元

已动用预备金 = max(0, 累计支出 - 可用概算)
剩余预备金 = 预备金总额 - 已动用预备金
```

#### 整体进度（加权平均）

```
整体进度 = Σ(子工程进度 × 子工程概算) / Σ(子工程概算)
```

- 权重为各子工程的分配概算，概算越大的工程对整体进度影响越大

---

### 4.2 预警计算逻辑

#### 概算超支预警

```
使用率 = 实际支出 / 分配概算

if 使用率 >= 90%  → 红灯预警（严重超支）
if 使用率 >= 80%  → 黄灯预警（接近超支）
```

- 阈值可在系统配置中调整（ALERT_RED_THRESHOLD、ALERT_YELLOW_THRESHOLD）

#### 工期延误预警

```
总工期天数 = 计划结束日 - 计划开始日
已过天数 = 今天 - 计划开始日
期望进度(%) = min(100, 已过天数 / 总工期天数 × 100)

if 期望进度 - 实际进度 > 20%  → 红灯预警
if 期望进度 - 实际进度 > 10%  → 黄灯预警
```

#### 消耗速率预警

```
已过月数 = (今天 - 首笔支出日期) / 30
月均消耗 = 累计支出 / 已过月数
剩余月数 = (项目结束日 - 今天) / 30
预计总支出 = 累计支出 + 月均消耗 × 剩余月数

if 预计总支出 > 总概算 × 110%  → 红灯预警
if 预计总支出 > 总概算         → 黄灯预警
```

---

### 4.3 What-if 模拟分析

**功能**: 拖动滑块调整某个子工程或费用项的参数，实时查看对全局的影响

**计算步骤**:

```
Step 1: 获取基准数据
  原始总成本 = Σ(所有子工程的分配概算)

Step 2: 计算每个调整项的增量
  对于每个调整参数:
    if 调整方式 == "百分比":
      增量 = 原始值 × (调整百分比 / 100)
    if 调整方式 == "绝对值":
      增量 = 调整值

Step 3: 计算调整后总成本
  调整后总成本 = 原始总成本 + Σ(所有增量)

Step 4: 判断概算状态
  可用概算 = 总概算 × (1 - 预备金比例)
  if 调整后总成本 > 总概算      → "超出概算"（over_budget）
  if 调整后总成本 > 可用概算    → "接近上限"（near_limit）
  else                          → "概算内"（within_budget）

Step 5: 弹性预备金影响
  总预备金 = 总概算 × 预备金比例
  需动用预备金 = max(0, 调整后总成本 - 可用概算)
  剩余预备金 = max(0, 总预备金 - 需动用预备金)

Step 6: KPI 影响
  概算控制率(%) = (1 - 调整后总成本 / 总概算) × 100
  成本变化率(%) = (调整后总成本 - 原始总成本) / 原始总成本 × 100
  原始概算使用率(%) = 原始总成本 / 总概算 × 100
  调整后概算使用率(%) = 调整后总成本 / 总概算 × 100
```

---

### 4.4 敏感性分析（龙卷风图）

**功能**: 展示哪些子工程/费用项对总成本影响最大，帮助决策者聚焦关键变量

**计算步骤**:

```
Step 1: 获取基准总成本
  基准总成本 = Σ(所有支出)

Step 2: 对每个目标项，计算正负扰动影响
  默认扰动范围: -20% ~ +20%

  对于每个目标项:
    基准值 = 目标项的当前概算
    低值影响 = 基准值 × (范围下限 / 100)   例: × (-0.20)
    高值影响 = 基准值 × (范围上限 / 100)   例: × (+0.20)
    低值总成本 = 基准总成本 + 低值影响
    高值总成本 = 基准总成本 + 高值影响

Step 3: 按影响幅度排序
  影响幅度 = |高值影响 - 低值影响|
  按影响幅度从大到小排序 → 生成龙卷风图
```

- 排在龙卷风图顶部的项目 = 对总成本影响最大的可控变量

---

### 4.5 情景对比分析

**功能**: 创建多个假设情景（保守/正常/乐观），对比不同方案下的成本和回报

**预置三套方案**:

| 方案 | 概算因子 | 工期因子 | 效率因子 | 含义 |
|------|---------|---------|---------|------|
| 保守方案 | 1.10 | 1.20 | 0.90 | 超概算10%，延期20%，效率降10% |
| 正常方案 | 1.00 | 1.00 | 1.00 | 按原计划执行 |
| 乐观方案 | 0.90 | 0.85 | 1.15 | 节约10%，提前15%，效率提升15% |

**计算公式**:

```
调整成本 = 总概算 × 概算因子
预计回报 = 总概算 × 效率因子 × 1.2（简化回报模型）
预计工期 = 12个月 × 工期因子
ROI(%) = (预计回报 - 调整成本) / 调整成本 × 100
概算节余 = 总概算 - 调整成本
效率提升(%) = (效率因子 - 1) × 100
```

---

### 4.6 月度报表计算

#### 下月支出预测

```
下月预估支出 = (本月支出 + 上月支出) / 2
```

- 简单移动平均法，后续可升级为加权平均或趋势外推

#### 剩余月数概算

```
剩余可用月数 = (总概算 - 累计支出) / 本月支出
```

- 表示按当前月度消耗速率，剩余概算还能支撑多少个月

#### 工期状态判断

```
总工期天数 = 计划结束日 - 计划开始日
已过天数 = min(报表截止日, 计划结束日) - 计划开始日
期望进度 = min(100, max(0, 已过天数 / 总工期天数 × 100))

if 实际进度 < 期望进度 - 10%  → "滞后"
if 实际进度 > 期望进度 + 10%  → "超前"
else                          → "正常"
```

#### 风险等级划分

```
if 概算使用率 >= 90%  → 红灯（高风险）
if 概算使用率 >= 80%  → 黄灯（中风险）
else                  → 绿灯（正常）
```

#### 自动建议生成

系统根据以下规则自动生成建议文本:
1. 如有子工程概算使用率 >= 90%，建议重点关注并控制支出
2. 如有子工程进度滞后，建议加大投入或调整计划
3. 如总体概算已超过可用概算线，提示正在使用弹性预备金
4. 如以上均无，显示"当前各项指标正常，请继续保持"

---

### 4.7 "降成本、控概算、提工效、抢工期"四大目标量化

| 目标 | 指标 | 计算公式 |
|------|------|----------|
| 降成本 | 概算控制率 | (1 - 累计支出 / 总概算) × 100% |
| 控概算 | 概算偏差率 | (实际支出 - 批复概算) / 批复概算 |
| 提工效 | 工效指数 | 实际产出 / (投入人工 × 投入工时)（需基线数据） |
| 抢工期 | 工期准时率 | (完成+进行中的子工程数) / 总子工程数 × 100% |

> 注: "提工效"（工效指数）和"降成本"（成本节约率）需要技改前的基线数据才能计算，目前系统中该值为 0，待数据补充后生效。

---

## 五、后续优化建议

1. **分级驾驶舱**: 可根据需要为不同角色展示不同详细程度的数据（如对 viewer 隐藏具体金额）
2. **数据录入流程**: 工程部录入的数据可增加审批流，由领导确认后生效
3. **用友NCC对接**: 实现财务数据自动同步，减少手动录入
4. **移动端适配**: 当前为 PC 端 Web 页面，可后续增加移动端适配
